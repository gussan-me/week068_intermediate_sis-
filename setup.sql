-- ========================================================================
-- Frosty Friday Week 68 - Snowflake セットアップスクリプト
-- 人口データの可視化 with Streamlit in Snowflake
-- ========================================================================

-- ========================================================================
-- 1. データベースとスキーマの作成
-- ========================================================================
-- 専用のデータベースとスキーマを作成して、整理された環境を構築します
CREATE DATABASE IF NOT EXISTS FROSTY_FRIDAY;
USE DATABASE FROSTY_FRIDAY;
CREATE SCHEMA IF NOT EXISTS POPULATION_DATA;
USE SCHEMA POPULATION_DATA;

-- ========================================================================
-- 2. 外部ステージの作成
-- ========================================================================
-- S3バケット上のデータにアクセスするための外部ステージを作成
-- ステージは、外部ストレージとSnowflakeを繋ぐ橋渡しの役割を果たします
CREATE OR REPLACE STAGE population_stage
    URL = 's3://frostyfridaychallenges/challenge_68/'
;
-- ========================================================================
-- 3. ステージ内のファイル確認
-- ========================================================================
-- ステージ内にあるファイルのリストを確認し、データ構造を理解します
LIST @population_stage;

-- ステージ内のデータの中身を確認
-- 実際のデータ形式とカラム構造を把握するために使用
SELECT 
    $1 AS raw_data
FROM @population_stage 
LIMIT 20;

-- ========================================================================
-- 4. テーブルの作成
-- ========================================================================
CREATE OR REPLACE TABLE POPULATION_DATA (
    country VARCHAR,      -- 国名
    pop2023 NUMBER,       -- 2023年の人口
    density NUMBER(38,10) -- 人口密度
);
select * from population_data;

-- ========================================================================
-- 5. データのロード
-- ========================================================================
-- ステージからデータをテーブルにコピー
-- 外部テーブルの定義と同じ形式でデータを読み込みます
-- CSVファイルには実際にはJSON配列形式のデータが含まれているため、
-- FILE_FORMATをJSONに設定し、STRIP_OUTER_ARRAYで配列を展開します
COPY INTO POPULATION_DATA (country, pop2023, density)
FROM (
    SELECT 
        $1:country::VARCHAR,
        $1:pop2023::NUMBER,
        $1:density::NUMBER(38,10)
    FROM @population_stage
)
FILE_FORMAT = (TYPE = JSON STRIP_OUTER_ARRAY = TRUE)
;

-- ========================================================================
-- 6. ロードされたデータの確認
-- ========================================================================
-- テーブルに正しくデータがロードされたか確認
SELECT * FROM POPULATION_DATA;

-- データ件数の確認
SELECT COUNT(*) AS total_countries FROM POPULATION_DATA;